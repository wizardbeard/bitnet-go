name: ci

on:
  push:
  pull_request:

jobs:
  cpu-parity-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true
      - name: cpu-parity-audit
        env:
          BITNET_PARITY_PROFILE: cpu_parity_v1
          BITNET_AUDIT_FETCH: "1"
          BITNET_YARN_MODEL_URL: https://huggingface.co/mradermacher/YarnGPT2b-GGUF/resolve/main/YarnGPT2b.f16.gguf
          BITNET_YARN_MODEL_FILE: YarnGPT2b.f16.gguf
          BITNET_I2S_2B_MODEL_URL: https://huggingface.co/microsoft/bitnet-b1.58-2B-4T-gguf/resolve/main/ggml-model-i2_s.gguf
          BITNET_I2S_2B_MODEL_FILE: ggml-model-i2_s.gguf
        run: |
          ./scripts/audit_cpu_parity.sh

  go:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true
      - name: fmt
        run: |
          test -z "$(gofmt -l .)"
      - name: vet
        run: |
          go vet ./...
      - name: fetch-gguf
        env:
          BITNET_FETCH_YARN: "1"
          BITNET_YARN_MODEL_URL: https://huggingface.co/mradermacher/YarnGPT2b-GGUF/resolve/main/YarnGPT2b.f16.gguf
          BITNET_YARN_MODEL_FILE: YarnGPT2b.f16.gguf
          BITNET_FETCH_I2S_2B: "1"
          BITNET_I2S_2B_MODEL_URL: https://huggingface.co/microsoft/bitnet-b1.58-2B-4T-gguf/resolve/main/ggml-model-i2_s.gguf
          BITNET_I2S_2B_MODEL_FILE: ggml-model-i2_s.gguf
        run: |
          sh ./scripts/fetch_testdata_gguf.sh
      - name: test
        run: |
          go test ./...
      - name: bench-i2s-kernels
        run: |
          ./scripts/bench_i2s_kernels.sh
        continue-on-error: true
      - name: upload-bench-i2s-kernels
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-i2s-kernels
          path: .bench/i2s-kernels.txt
          if-no-files-found: warn
      - name: bench-smoke
        run: |
          go test ./... -bench . -benchmem
        continue-on-error: true
      - name: bench-perf-repeat-threads
        run: |
          BITNET_REPEAT_RUNS=2 \
          BITNET_REPEAT_THREADS="1 4 6 8" \
          BITNET_I2S_I8S_FAST_PAR_COLS_MIN=512 \
          ./scripts/bench_perf_repeat_matrix.sh
        continue-on-error: true
      - name: select-perf-repeat-threads
        if: always()
        run: |
          if [ -f .bench/perf-repeat-summary.tsv ]; then
            ./scripts/validate_perf_repeat_summary.sh .bench/perf-repeat-summary.tsv
            ./scripts/select_perf_repeat_threads.sh .bench/perf-repeat-summary.tsv
          else
            echo "Skipping select step (summary missing)"
          fi
        continue-on-error: true
      - name: report-perf-repeat-drift
        if: always()
        run: |
          if [ -f .bench/perf-repeat-summary.tsv ] && [ -f testdata/perf-repeat-summary-baseline.tsv ]; then
            ./scripts/report_perf_repeat_drift.sh .bench/perf-repeat-summary.tsv testdata/perf-repeat-summary-baseline.tsv
          else
            echo "Skipping drift report (summary or baseline missing)"
          fi
        continue-on-error: true
      - name: upload-bench-perf-repeat
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-perf-repeat
          path: |
            .bench/perf-repeat-summary.tsv
            .bench/perf-repeat-best.env
            .bench/perf-repeat-drift.tsv
            .bench/perf-repeat-threads*.tsv
          if-no-files-found: warn
      - name: bench-kernels
        run: |
          go test ./internal/kernels -bench . -benchmem
        continue-on-error: true
      - name: bench-runtime
        run: |
          go test ./internal/runtime -bench . -benchmem
        continue-on-error: true
  bench-arm64-i2s:
    if: ${{ false }} # Temporarily disabled; re-enable when arm64 runner/tuning is resumed.
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true
      - name: bench-i2s-kernels-arm64
        run: |
          BITNET_I2S_BENCH_TIME=120ms ./scripts/bench_i2s_kernels.sh
      - name: sweep-i2s-kernels-arm64
        run: |
          BITNET_I2S_BENCH_TIME=40ms \
          BITNET_I2S_SWEEP_THREADS=4 \
          ./scripts/bench_i2s_kernels_sweep.sh
      - name: select-i2s-defaults-arm64
        run: |
          ./scripts/select_i2s_defaults.sh .bench/i2s-kernels-sweep-summary.tsv
      - name: upload-bench-i2s-kernels-arm64
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-i2s-kernels-arm64
          path: .bench/i2s-kernels.txt
          if-no-files-found: warn
      - name: upload-bench-i2s-sweep-arm64
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-i2s-sweep-arm64
          path: .bench/i2s-kernels-sweep.txt
          if-no-files-found: warn
      - name: upload-bench-i2s-sweep-summary-arm64
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-i2s-sweep-summary-arm64
          path: .bench/i2s-kernels-sweep-summary.tsv
          if-no-files-found: warn
      - name: upload-i2s-defaults-arm64
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: i2s-defaults-arm64
          path: .bench/i2s-kernels-defaults.env
          if-no-files-found: warn
